{% extends 'portal/base.html' %}
{% load static wagtailuserbar %}
{% load wagtailcore_tags wagtailimages_tags %}
<!doctype html>

{% block title %} Invoice Payment {% endblock title %}

{% block script %}
<script type="text/javascript">
var stripe = Stripe('{{ publishKey }}');
var elements = stripe.elements();

// Custom styling can be passed to options when creating an Element.
var style = {
  base: {
    // Add your base input styles here. For example:
    fontSize: '16px',
    color: "#32325d",
  }
};

// Create an instance of the card Element.
var card = elements.create('card', {style: style});

// Add an instance of the card Element into the `card-element` <div>.
card.mount('#card-element');

card.addEventListener('change', function(event) {
  var displayError = document.getElementById('card-errors');
  if (event.error) {
    displayError.textContent = event.error.message;
  } else {
    displayError.textContent = '';
  }
});

//3 Create a token or display an error when the form is submitted.
var form = document.getElementById('payment-form');
form.addEventListener('submit', function(event) {
  event.preventDefault();

  stripe.createToken(card).then(function(result) {
    if (result.error) {
      // Inform the customer that there was an error.
      var errorElement = document.getElementById('card-errors');
      errorElement.textContent = result.error.message;
    } else {
      // Send the token to your server.
      stripeTokenHandler(result.token);
    }
  });
});

function stripeTokenHandler(token) {
  // Insert the token ID into the form so it gets submitted to the server
  var form = document.getElementById('payment-form');
  var hiddenInput = document.createElement('input');
  hiddenInput.setAttribute('type', 'hidden');
  hiddenInput.setAttribute('name', 'stripeToken');
  hiddenInput.setAttribute('value', token.id);
  form.appendChild(hiddenInput);

  // Submit the form
  form.submit();
}

</script>

{% endblock script %}

{% block jquery %}
// Create a token or display an error when the form is submitted.
var form = document.getElementById('payment-form');
form.addEventListener('submit', function(event) {
  event.preventDefault();

  stripe.createToken(card).then(function(result) {
    if (result.error) {
      // Inform the customer that there was an error.
      var errorElement = document.getElementById('card-errors');
      errorElement.textContent = result.error.message;
    } else {
      // Send the token to your server.
      stripeTokenHandler(result.token);
    }
  });
});
{% endblock jquery %}

{% block extra_css %}
  <link rel="stylesheet" type="text/css" href="{% static 'css/stripe.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/store.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/global.css' %}">

  <style>
  table.table tbody tr td,
  table.table thead tr th,
  table.table thead {
    border-left: none;
    border-right: none;
    border-bottom: 1px solid #cecece;
    border-top: 1px solid #cecece;
  }

  </style>
{% endblock %}






{% block content %}
<section>
  <div class="container-fluid section-sm-secondary" style="margin-top: 60px;">
      <div class="container text-box text-white">
          <span><a href="{% slugurl 'home' %}"><i class="text-light fa fa-home" aria-hidden="true"></i></a> / <a class="text-light" href="{% url 'userPage' %}">Profile</a> / Invoice Checkout</span>
          <h1>Invoice Checkout</h1>
      </div>
  </div>
</section>
  <div class="container">
    <div style="display: inline;">
        <form action="." method="POST" id="">{% csrf_token %}
          <script
            src="https://checkout.stripe.com/checkout.js" class="stripe-button"
            data-key="{{ publishKey }}"
            data-amount="{{ invoice.stripe_total }}"
            data-name="ModTechnologies.io"
            data-description="{{ invoice }} Payment"
            data-image="{% static 'img/logo_5.svg' %}"
            data-locale="auto"
            data-zip-code="true">PROCEED TO CHECKOUT
          </script>
          <script>
            // Hide default stripe button, be careful there if you
            // have more than 1 button of that class
            document.getElementsByClassName("stripe-button-el")[0].style.display = 'none';
          </script>
          <button type="submit" style="max-width: 15rem;" class="btn btn-success-alt px-2"><i class="fa fa-credit-card mr-1" aria-hidden="true"></i> Pay Invoice Online</button>
          <a class="btn btn-primary-alt px-4" style="font-weight: 500;" href="{% url 'memberships:invoice_pdf' invoice.pk %}"><i class="fa fa-file-pdf-o mr-1" aria-hidden="true"></i> Generate PDF</a>
        </form>
    </div>
    <div class="card">
      <div class="card-body p-5">
        <div class="row text-left">
              <div class="col-lg-3" style="display: inline-block;">
                  <img class="" src="{% static 'img/logo_10.svg'%}" style="width:100%;" alt="First slide">
              </div>
              <div class="col-lg-4 text-left pt-2">
                  <p style="font-size: .85rem;" >Mod Technologies LLC <br>26300 johns rd, <br> South Lyon, MI 48178</p>
              </div>
              <div class="offset-lg-1"></div>
              <div class="col-lg-4">
                <dl class="row text-left ">
                <dt class="col-sm-5">Invoice Number</dt>
                <dd class="col-sm-7">#{{ invoice.invoice_id }}</dd>
                <dt class="col-sm-4 mt-3">Issue Date</dt>
                <dd class="col-sm-8 mt-3">{{ invoice.issue_date }}</dd>
                <dt class="col-sm-4 mt-3">Due Date</dt>
                <dd class="col-sm-8 mt-3">{{ invoice.due_date }}</dd>
                </dl>
                <div class="invoice">
                    <span class="invoice-card">DUE</span>
                    <span class="invoice-card-inverse">${{invoice.amount }}</span>
                </div>
                <div class="offset-lg-12 py-3 unhide"></div>
              </div>
              <div class="col-lg-12">
                <span style="font-weight: 500;">Bill To:</span> <br>
                first last <br>
                address <br>
                state
              </div>
                <div class="col-lg-12">
                    <div class="table-responsive mt-4 my-3">
                        <table class="table text-center" style="">
                            <thead >
                                <tr>
                                  <th scope="col" class="text-dark text-left">Item</th>
                                  <th scope="col" class="text-dark text-right">Quantity</th>
                                  <th scope="col" class="text-dark text-right">Unit price</th>
                                  <th scope="col" class="text-dark text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                  {% for object in invoice.all_charges %}
                                  <tr>
                                    <td class="text-dark text-left">{{ object.description }}</td>
                                    <td class="text-dark text-right">{{ object.hours }}</td>
                                    <td class="text-dark text-right">{{ object.rate }}</td>
                                    <td class="text-dark text-right">{{ object.charge_total }}</td>
                                  </tr>
                                  {% endfor %}

                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card my-3" style="box-shadow: none;">
                      <div class="card-body" style="background-color: #f3f3f3; ">
                        <p class="py-0">Discount(s) Applied:</p>
                        <hr>
                        <dl class="row text-left">
                            <dt class="col-sm-6 mt-3">1. {{ invoice.discount.name }}</dt>
                            <dd class="col-sm-6 mt-3 text-right">-{{ invoice.discount.get_percentage }}%</dd>

                        </dl>
                      </div>
                    </div>
                </div>
                <div class="offset-lg-2"></div>
                <div class="col-lg-5 my-3">
                    <dl class="row text-right">
                        <dt class="col-sm-6">Subtotal</dt>
                        <dd class="col-sm-6">${{ invoice.amount }}</dd>
                        <dt class="col-sm-6 mt-3">Discounts</dt>
                        <dd class="col-sm-6 mt-3">({{ invoice.discount.get_percentage }}%)</dd>
                        <dt class="col-sm-6 mt-3">Total</dt>
                        <dd class="col-sm-6 mt-3">${{ invoice.amount }}</dd>
                    </dl>
                    <hr>
                    <dl class="row text-right">
                        <dt class="col-sm-6">Paid</dt>
                        <dd class="col-sm-6">$0.00</dd>
                        <dt class="col-sm-6 mt-3">Due</dt>
                        <dd class="col-sm-6 mt-3">${{ invoice.amount }}</dd>
                    </dl>
                </div>

            </div>
        </div>
    </div>

<div class="py-5"></div>
<div class="text-right"><i class="fa fa-lock text-success" aria-hidden="true"></i> <strong><span class="text-success">SSL</span> SECURED PAYMENT</strong><br>
  <span class="text-muted" style="font-size: 14px;">Your information is protected by 256-bit SSL encryption</span>
</div>
<hr>
</div>
  <div class="py-5"></div>
  <div class="py-5"></div>
  <div class="py-4"></div>
{% endblock %}
{% block scripts %}
  {{ block.super }}
  <script>
  $('#myModal').on('shown.bs.modal', function () {
  $('#myInput').trigger('focus')
})
  </script>
{% endblock scripts %}
